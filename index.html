<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Upload with S3 Presigned URL</title>
    <link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Your existing styles here */
    </style>
</head>
<body>
    <h2>Video Upload with S3 Presigned 7</h2>
    <div class="center">
        <input type="file" id="fileInput" accept="*/*" />
        <p id="fileName">No file selected</p>
        <button id="uploadButton">Upload File</button>
        <p id="statusMessage"></p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // ... (previous code remains the same) ...

            async function createVideoRecord(file) {
                const createRecordUrl = "https://hook.us1.make.com/egyfg1bky35yp3yt7x5df4cjh5tl5mbs";

                const payload = {
                    hunt_id: huntId,
                    user_id: userId,
                    filename: file.name,
                    filetype: file.type,
                    filesize: file.size
                };

                try {
                    const response = await fetch(createRecordUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    console.log("Raw response from Make.com webhook:", data);

                    if (typeof data === 'number') {
                        // If the response is just a number, assume it's the record ID
                        return data.toString();
                    } else if (data && typeof data === 'object') {
                        // If it's an object, look for a field that might contain the record ID
                        const possibleIdFields = ['record_id', 'id', 'videoId', 'video_id'];
                        for (const field of possibleIdFields) {
                            if (data[field]) {
                                return data[field].toString();
                            }
                        }
                    }

                    throw new Error("Unexpected response format. Unable to extract record ID.");
                } catch (error) {
                    console.error("Error creating video record:", error);
                    showMessage(`Failed to create video record: ${error.message}`, false);
                    return null;
                }
            }

            // ... (rest of the code remains the same) ...

            uploadButton.onclick = async function () {
                console.log("Upload button clicked...");

                const file = fileInput.files[0];
                if (!file) {
                    alert("Please select a file first.");
                    return;
                }

                console.log("Selected file details - Name:", file.name, ", Type:", file.type, ", Size:", file.size);

                try {
                    showMessage("Creating video record...", true);
                    const videoRecordId = await createVideoRecord(file);
                    if (!videoRecordId) {
                        throw new Error("Failed to create video record");
                    }
                    console.log("Created video record with ID:", videoRecordId);

                    // ... (rest of the upload process remains the same) ...

                } catch (error) {
                    console.error("Error in upload process:", error);
                    showMessage(`Upload process failed: ${error.message}`, false);
                }
            };
        });
    </script>
</body>
</html>
